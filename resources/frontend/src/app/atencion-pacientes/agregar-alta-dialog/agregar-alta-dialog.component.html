<div class="form-loading-shade" *ngIf="isLoading"><mat-spinner *ngIf="isLoading"></mat-spinner></div>
<div class="form-loading-shade" *ngIf="!isLoading && !paciente">No se encontraron los datos del Paciente</div>

<!-- <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">
    <h2 fxFlex><mat-icon>assignment_ind</mat-icon> Información del Paciente: </h2>
</div> -->

<div>

    <div class="form-container">

        <mat-card>
            <mat-card-title class="icon-text">
                <mat-icon>sick</mat-icon>&nbsp;Paciente:
            </mat-card-title>
            <br>
            <mat-card-content>

                <div *ngIf="paciente.esDesconocido == 1" fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>repeat_one_on</mat-icon>&nbsp;N° Expediente: </mat-label>
                        <input class="formato-paciente" matInput value="{{paciente.numero_expediente}}" placeholder="N° de Expediente" readonly>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>no_accounts</mat-icon>&nbsp;Alias: </mat-label>
                        <input class="formato-paciente" matInput value="{{paciente.alias}}" placeholder="Alias" readonly>
                    </mat-form-field>

                </div>

                <div *ngIf="paciente.esDesconocido == 1" fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>filter_9</mat-icon>&nbsp;Edad Aparente: </mat-label>
                        <input class="formato-paciente" matInput value="{{ paciente.edad_aparente+' '+paciente.tipo_edad }}" placeholder="Edad" readonly>
                    </mat-form-field>


                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>hotel</mat-icon>&nbsp;Días de Estancia Hospitalaria: </mat-label>
                        <input class="formato-paciente" matInput value="{{this.diasEstancia}}" placeholder="Alias" readonly>
                    </mat-form-field>

                </div>

                <div *ngIf="paciente.esDesconocido == 0" fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">


                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>repeat_one_on</mat-icon>&nbsp;N° Expediente: </mat-label>
                        <input class="formato-paciente" matInput value="{{paciente.numero_expediente}}" placeholder="N° de Expediente" readonly>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>contact_emergency</mat-icon>&nbsp;Nombre: </mat-label>
                        <input class="formato-paciente" matInput value="{{ paciente.nombre }} {{ paciente.paterno }} {{ paciente.materno }}" placeholder="Nombre Completo" readonly>
                    </mat-form-field>
                
                </div>

                <div *ngIf="paciente.esDesconocido == 0" fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <!-- <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>celebration</mat-icon>&nbsp;Fecha de Nacimiento: </mat-label>
                        <input class="formato-paciente" matInput value="{{paciente.fecha_nacimiento}}" placeholder="Fecha de Nacimiento" readonly>
                    </mat-form-field>

                    <mat-form-field fxFlex *ngIf="paciente.esExtranjero == 0">
                        <mat-label><mat-icon matPrefix>credit_score</mat-icon>&nbsp;CURP: </mat-label>
                        <input class="formato-paciente" matInput value="{{paciente.curp}}" placeholder="CURP" readonly>
                    </mat-form-field> -->

                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>filter_9</mat-icon>&nbsp;Edad: </mat-label>
                        <input class="formato-paciente" matInput value="{{ paciente.edad+' '+paciente.tipo_edad }}" placeholder="Edad" readonly>
                    </mat-form-field>

                    <mat-form-field fxFlex>
                        <mat-label><mat-icon matPrefix>hotel</mat-icon>&nbsp;Días de Estancia Hospitalaria: </mat-label>
                        <input class="formato-paciente" matInput value="{{this.diasEstancia}}" placeholder="Alias" readonly>
                    </mat-form-field>


                </div>

            </mat-card-content>
        </mat-card>

        <div [formGroup]="pacienteForm">
        <!-- <div [formGroup]="pacienteForm" *ngIf="this.pacienteForm.controls['ultima_atencion'].get('esAmbulatoria').value == 1"> -->

            <!-- <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">
                <h2 fxFlex><mat-icon>local_hospital</mat-icon>&nbsp;Atención Ambulatoria:
                </h2>
            </div>


            <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px" formGroupName="ultima_atencion">

                <mat-form-field fxFlex="45%" appearance="fill">
                    <mat-label>Folio de la Atención: </mat-label>
                    <input matInput  formControlName="folio_atencion" readonly>
                </mat-form-field>

                <mat-form-field fxFlex appearance="fill">
                    <mat-label>Fecha de la Atención: </mat-label>
                    <input matInput [value]="this.pacienteForm.controls['ultima_atencion'].get('fecha_inicio_atencion').value | date: 'dd/MM/yyyy'" readonly>
                </mat-form-field>

                <mat-form-field fxFlex appearance="fill">
                    <mat-label>Hora de la Atención: </mat-label>
                    <input matInput  formControlName="hora" readonly>
                </mat-form-field>
        
            </div>

            <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px" formGroupName="ultima_atencion">


                <mat-form-field fxFlex appearance="fill">
                    <mat-label>Motivo de la Atención: </mat-label>
                    <textarea matInput id="indicaciones" formControlName="motivo_atencion" placeholder="Motivo de la Atencion" readonly></textarea>
                </mat-form-field>


                <mat-form-field fxFlex appearance="fill">
                    <mat-label>Observaciones: </mat-label>
                    <textarea matInput id="indicaciones" formControlName="indicaciones" placeholder="Observaciones" readonly></textarea>
                </mat-form-field>             

            </div> -->

            <div  formGroupName="alta">

                <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">
                    <h2 fxFlex><mat-icon>accessible_forward</mat-icon>&nbsp;Alta/Egreso:
                    </h2>
                </div>

                <!-- <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">
                    
                    <mat-form-field fxFlex appearance="fill">
                        <mat-label>Folio del Alta/Egreso: </mat-label>
                        <input matInput  formControlName="folio_alta" readonly>
                    </mat-form-field>

                </div> -->

                <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field appearance="fill" fxFlex>

                        <mat-label>Fecha del Alta/Egreso: </mat-label>
                        <input matInput [min]="minDate" [max]="maxDate" [matDatepicker]="picker2" formControlName="fecha_alta" placeholder="Fecha de Nacimiento" readonly>
                        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
                        <mat-datepicker #picker2></mat-datepicker>

                        <mat-error *ngIf="pacienteForm.controls['alta'].get('fecha_alta').invalid && (pacienteForm.controls['alta'].get('fecha_alta').dirty || pacienteForm.controls['alta'].get('fecha_alta').touched)">
                            <span *ngIf="pacienteForm.controls['alta'].get('fecha_alta').errors.required">La Fecha del Alta/Egreso es obligatoria</span>
                        </mat-error>

                    </mat-form-field>
                    
        
                    <mat-form-field appearance="fill" fxFlex>
                        <mat-label>Hora del Alta/Egreso: </mat-label>
                        <input matInput formControlName="hora_alta" placeholder="Hora del Alta" readonly>
                    </mat-form-field>

                </div>


                <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['estados_actuales']">
                        <mat-label>Estado de Salud del Alta/Egreso:</mat-label>
                        <input matInput formControlName="estado_actual_id">
                        <mat-hint>Escribe el nombre del Estado de Salud Actual</mat-hint>
                        <mat-error *ngIf="pacienteForm.controls['alta'].get('estado_actual_id').hasError('required')">Este campo es obligatorio</mat-error>
                    </mat-form-field>

                    <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['estados_actuales']">
                        <mat-label>Estado de Salud del Alta/Egreso:</mat-label>
                        <input type="text" aria-label="estado_actual_id" matInput formControlName="estado_actual_id" [matAutocomplete]="estadoActualAutocomplete" required >
                        <mat-autocomplete #estadoActualAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')">
                            <mat-option *ngFor="let item of filteredCatalogs['estados_actuales'] | async" [value]="item">
                                {{item.nombre}}
                            </mat-option>
                        </mat-autocomplete>
                        <mat-hint *ngIf="!pacienteForm.controls['alta'].get('estado_actual_id').value">Selecciona un Estado de Salud Actual de la lista</mat-hint>
                        <mat-hint align="end" *ngIf="pacienteForm.controls['alta'].get('estado_actual_id').value">Nombre: [{{pacienteForm.controls['alta'].get('estado_actual_id').value.nombre}}]</mat-hint>
                        <mat-error *ngIf="pacienteForm.controls['alta'].get('estado_actual_id').hasError('required')">Este campo es obligatorio</mat-error>
                    </mat-form-field>


                    <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['motivos_egresos']">
                        <mat-label>Motivo del Alta/Egreso:</mat-label>
                        <input matInput formControlName="motivo_egreso_id">
                        <mat-hint>Escribe el nombre del Motivo del Alta/Egreso</mat-hint>
                        <mat-error *ngIf="pacienteForm.controls['alta'].get('motivo_egreso_id').hasError('required')">Este campo es obligatorio</mat-error>
                    </mat-form-field>

                    <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['motivos_egresos']">
                        <mat-label>Motivo del Alta/Egreso:</mat-label>
                        <input type="text" aria-label="motivo_egreso_id" matInput formControlName="motivo_egreso_id" [matAutocomplete]="estadoActualAutocomplete" required >
                        <mat-autocomplete #estadoActualAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')">
                            <mat-option *ngFor="let item of filteredCatalogs['motivos_egresos'] | async" [value]="item">
                                {{item.nombre}}
                            </mat-option>
                        </mat-autocomplete>
                        <mat-hint *ngIf="!pacienteForm.controls['alta'].get('motivo_egreso_id').value">Selecciona un Motivo del Alta/Egreso de la lista</mat-hint>
                        <mat-hint align="end" *ngIf="pacienteForm.controls['alta'].get('motivo_egreso_id').value">Nombre: [{{pacienteForm.controls['alta'].get('motivo_egreso_id').value.nombre}}]</mat-hint>
                        <mat-error *ngIf="pacienteForm.controls['alta'].get('motivo_egreso_id').hasError('required')">Este campo es obligatorio</mat-error>
                    </mat-form-field>


                </div>

                <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field fxFlex appearance="fill">
                        <mat-label>Observaciones del Alta/Egreso: </mat-label>
                        <textarea matInput id="indicaciones" formControlName="observaciones" placeholder="Observaciones"></textarea>
                    </mat-form-field> 


                </div>

                <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field fxFlex appearance="fill">
                        <mat-label>Diagnósticos del Alta/Egreso: </mat-label>
                        <textarea matInput id="observaciones_diagnosticos" formControlName="observaciones_diagnosticos" placeholder="Diagnósticos de Egreso"></textarea>
                        <mat-error *ngIf="pacienteForm.controls['alta'].get('observaciones_diagnosticos').invalid && (pacienteForm.controls['alta'].get('observaciones_diagnosticos').dirty || pacienteForm.controls['alta'].get('observaciones_diagnosticos').touched)">
                            <span *ngIf="pacienteForm.controls['alta'].get('observaciones_diagnosticos').errors.required">El campo es obligatorio</span>
                        </mat-error>
                    </mat-form-field> 


                </div>
                <br>
                
                <div *ngIf="paciente.sexo === 'Femenino'">
                    <mat-hint><mat-slide-toggle [checked]="PuerperaEmbarazada" (change)="datosPuerperio($event)"><strong>¿Es una Paciente Puerpera ó Embarazada?</strong></mat-slide-toggle></mat-hint>
                    <mat-divider></mat-divider>
                </div>

                <br>
                <div *ngIf="PuerperaEmbarazada">

                    <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                        <mat-form-field fxFlex appearance="fill">
                            <mat-label>Teléfono de Contacto: </mat-label>
                            <input matInput id="telefono" formControlName="telefono" placeholder="Teléfono">
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('telefono').invalid && (pacienteForm.controls['alta'].get('telefono').dirty || pacienteForm.controls['alta'].get('telefono').touched)">
                                <span *ngIf="pacienteForm.controls['alta'].get('telefono').errors.required">El campo es obligatorio</span>
                            </mat-error>
                        </mat-form-field>
                        
                        <mat-form-field fxFlex appearance="fill">
                            <mat-label>Dirección Completa (Recuperación): </mat-label>
                            <input matInput id="direccion_completa" formControlName="direccion_completa" placeholder="Dirección Completa">
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('direccion_completa').invalid && (pacienteForm.controls['alta'].get('direccion_completa').dirty || pacienteForm.controls['alta'].get('direccion_completa').touched)">
                                <span *ngIf="pacienteForm.controls['alta'].get('direccion_completa').errors.required">El campo es obligatorio</span>
                            </mat-error>
                        </mat-form-field> 
    
                    </div>

                    <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                        <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['condiciones_egreso']">
                            <mat-label>Condición de Egreso:</mat-label>
                            <input matInput formControlName="condicion_egreso_id">
                            <mat-hint>Escribe el nombre de la Condición de Egreso</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('condicion_egreso_id').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>
    
                        <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['condiciones_egreso']">
                            <mat-label>Condición de Egreso:</mat-label>
                            <input type="text" aria-label="condicion_egreso_id" matInput formControlName="condicion_egreso_id" [matAutocomplete]="condicionEgresoAutocomplete" required >
                            <mat-autocomplete #condicionEgresoAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')">
                                <mat-option *ngFor="let item of filteredCatalogs['condiciones_egreso'] | async" [value]="item">
                                    {{item.nombre}}
                                </mat-option>
                            </mat-autocomplete>
                            <mat-hint *ngIf="!pacienteForm.controls['alta'].get('condicion_egreso_id').value">Selecciona una Condición de Egreso de la lista</mat-hint>
                            <mat-hint align="end" *ngIf="pacienteForm.controls['alta'].get('condicion_egreso_id').value">Nombre: [{{pacienteForm.controls['alta'].get('condicion_egreso_id').value.nombre}}]</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('condicion_egreso_id').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>

                        <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['metodos_anticonceptivos']">
                            <mat-label>Método Anticonceptivo:</mat-label>
                            <input matInput formControlName="metodo_anticonceptivo_id">
                            <mat-hint>Escribe el nombre de la Condición de Egreso</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('metodo_anticonceptivo_id').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>
    
                        <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['metodos_anticonceptivos']">
                            <mat-label>Método Anticonceptivo:</mat-label>
                            <input type="text" aria-label="metodo_anticonceptivo_id" matInput formControlName="metodo_anticonceptivo_id" [matAutocomplete]="metodoAnticonceptivoAutocomplete" required >
                            <mat-autocomplete #metodoAnticonceptivoAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')">
                                <mat-option *ngFor="let item of filteredCatalogs['metodos_anticonceptivos'] | async" [value]="item">
                                    {{item.nombre}}
                                </mat-option>
                            </mat-autocomplete>
                            <mat-hint *ngIf="!pacienteForm.controls['alta'].get('metodo_anticonceptivo_id').value">Selecciona una Condición de Egreso de la lista</mat-hint>
                            <mat-hint align="end" *ngIf="pacienteForm.controls['alta'].get('metodo_anticonceptivo_id').value">Nombre: [{{pacienteForm.controls['alta'].get('metodo_anticonceptivo_id').value.nombre}}]</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('metodo_anticonceptivo_id').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>
                        
                    </div>

                    <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                        <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['municipios']">
                            <mat-label>Municipio donde se Recuperara:</mat-label>
                            <input matInput formControlName="municipio">
                            <mat-hint>Escribe el nombre del Municipio</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('municipio').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>
    
                        <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['municipios']">
                            <mat-label>Municipio donde se Recuperara:</mat-label>
                            <input type="text" aria-label="municipio" matInput formControlName="municipio_id" [matAutocomplete]="municipioAutocomplete" required (blur)="checkAutocompleteValue('municipio_id')">
                            <mat-autocomplete #municipioAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')" (optionSelected)="cargarLocalidades($event)">
                                <mat-option *ngFor="let item of filteredCatalogs['municipios'] | async" [value]="item">
                                    {{item.nombre}}
                                </mat-option>
                            </mat-autocomplete>
                            <mat-hint *ngIf="!pacienteForm.controls['alta'].get('municipio_id').value">Selecciona un Municipio de la lista</mat-hint>
                            <mat-hint align="end" *ngIf="pacienteForm.controls['alta'].get('municipio_id').value">Clave: [{{pacienteForm.controls['alta'].get('municipio_id').value.clave}}]</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('municipio_id').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>

                        <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['localidades']">
                            <mat-label>Localidad donde se Recuperara:</mat-label>
                            <input matInput formControlName="localidad" required>
                            <mat-hint>Escribe el nombre de la localidad</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('localidad').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>
                
                        <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['localidades']">
                            <mat-label>Localidad donde se Recuperara:</mat-label>
                            <input type="text" aria-label="localidad" matInput formControlName="localidad_id" [matAutocomplete]="localidadAutocomplete" required (blur)="checkAutocompleteValue('localidad_id')">
                            <mat-autocomplete #localidadAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')">
                                <mat-option *ngFor="let item of filteredCatalogs['localidades'] | async" [value]="item">
                                    {{item.nombre}}
                                </mat-option>
                            </mat-autocomplete>
                            <mat-hint *ngIf="!pacienteForm.controls['alta'].get('localidad_id').value">Selecciona una localidad de la lista</mat-hint>
                            <mat-hint align="end" *ngIf="pacienteForm.controls['alta'].get('localidad_id').value">Clave: [{{pacienteForm.controls['alta'].get('localidad_id').value.clave}}]</mat-hint>
                            <mat-error *ngIf="pacienteForm.controls['alta'].get('localidad_id').hasError('required')">Este campo es obligatorio</mat-error>
                        </mat-form-field>
                </div>

                </div>

                <!-- <div fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">

                    <mat-form-field fxFlex appearance="fill"  *ngIf="!catalogos['diagnosticos']">
                        <mat-label>Diagnosticos:</mat-label>
                        <input matInput formControlName="diagnostico_id">
                    </mat-form-field>

                    <mat-form-field fxFlex appearance="fill" *ngIf="catalogos['diagnosticos']">
                        <mat-label>Diagnosticos:</mat-label>
                        <input type="text" aria-label="diagnostico_id" matInput formControlName="diagnostico_id" [matAutocomplete]="diagnosticoAutocomplete">
                        <mat-autocomplete #diagnosticoAutocomplete="matAutocomplete" [displayWith]="getDisplayFn('nombre')" (optionSelected)="asignarDiagnosticos($event)">
                            <mat-option *ngFor="let item of filteredCatalogs['diagnosticos'] | async" [value]="item">
                                {{item.nombre}}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>

                </div> -->
                <!-- <br>
                <div formArrayName="diagnosticos" *ngFor="let diag of pacienteForm.controls['alta'].get('diagnosticos')['controls']; let i = index">
                    <mat-card fxLayout.gt-sm="row" fxLayout="column" fxLayoutGap.gt-sm="10px">
                        <mat-form-field fxFlex >
                            <mat-label>Diagnostico: {{i+1}} </mat-label>
                            <input matInput [formControlName]="i" value="{{ diag.value.nombre }}" readonly>
                            <input matInput value="{{ diag.value.nombre }}" readonly>
                        </mat-form-field> 
                        <button mat-icon-button color="warn" matTooltip="Quitar Diagnostico" (click)="removeGroup(i)"  ><mat-icon>delete</mat-icon></button>
                    </mat-card>
                    <br>
                </div> -->

            </div>

        </div>
        
    </div>
</div>
<mat-divider></mat-divider>
<div mat-dialog-actions>
    <span fxFlex></span>
    <button mat-button (click)='onNoClick()'>Cancelar</button>
    <button mat-raised-button (click)="savePaciente()" color="primary" [disabled]="pacienteForm.invalid || isLoading"><mat-icon>save</mat-icon> Guardar Alta/Egreso</button>
</div>